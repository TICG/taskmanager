@page
@model IndexModel
@{
    ViewData["Title"] = "Home page";
}

<div class="row" style="padding-top: 5px">
    <div class="col-lg-3 col-md-4 col-sm-4 col-xs-4">
        <a asp-page="/Index">
            <img id="ukhoLogo" src="~/images/ukhologo.svg" class="img-responsive" alt="UKHO Logo" />
        </a>
    </div>
    <div class="col-lg-9 col-md-8 col-sm-8 col-xs-8">
        <div class="row">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <button id="btnMyTaskList" class="btn btn-primary"><span style="padding-right: 5px;"></span>My Task List</button>
                <button id="btnTeamTasks" class="btn btn-primary"><span style="padding-right: 5px;"></span>Team Tasks</button>
                <button id="btnStats" class="btn btn-primary"><span style="padding-right: 5px;"></span>Statistics</button>
                <button id="btnHistorical" class="btn btn-primary"><span style="padding-right: 5px;"></span>Historical Tasks</button>
            </div>
        </div>
        <div class="row" style="padding-top: 5px">
            <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
                <div class="right-inner-addon">
                    <i class="glyphicon glyphicon-search"></i>
                    <input id="txtGlobalSearch" type="search" class="form-control" placeholder="Search" />
                </div>
            </div>
            <div class="col-lg-6 col-md-6 col-sm-6 col-xs-6">
                <div class="pull-right">
                    <button id="btnRefresh" type="button" class="btn btn-primary" data-toggle="popover" data-placement="bottom" data-trigger="hover" data-content="Refresh the list of tasks in both tabs, preserving selected sort options and search criteria."><span class="fas fa-sync-alt"></span></button>
                    <button class="btn btn-primary dropdown" type="button" id="btnSelectStage" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Select Stage</button>
                    <button class="btn btn-primary dropdown" type="button" id="btnSelectTeam" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">Select Team</button>
                </div>
            </div>
        </div>
    </div>
</div>

<br />

<div class="panel panel-default">
    <div class="panel-heading">
        <span>Unassigned Tasks</span>
    </div>

    <div class="panel-body table-responsive">
        <table id="unassignedTasks" class="task-list table-striped" style="width: 100%">
            <thead>
                <tr>
                    <th>Process ID</th>
                    <th><div>Days to DM</div><div>End Date</div></th>
                    <th>DM End Date</th>
                    <th>Days On Hold</th>
                    <th>RSDRA No.</th>
                    <th>Source Name</th>
                    <th>Workspace</th>
                    <th>Task Type</th>
                    <th>Task Stage</th>
                    <th>Assessor</th>
                    <th>Verifier</th>
                    <th>Team</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>

                @foreach (var task in Model.Tasks.Where(t => string.IsNullOrEmpty(t.DbAssessmentReviewDataAssessor) && string.IsNullOrEmpty(t.DbAssessmentReviewDataVerifier)))
                {
                    <tr>
                        <td>
                            <a asp-area="DbAssessment"
                               asp-page="Review"
                               asp-route-processid="@task.ProcessId">@task.ProcessId</a>
                        </td>
                        <td>
                            @task.DaysToDmEndDate
                        </td>
                        <td>
                            @task.DmEndDate.ToShortDateString()
                        </td>
                        <td>
                            @task.DaysOnHold
                        </td>
                        <td>
                            @task.AssessmentDataRsdraNumber
                        </td>
                        <td>
                            @task.AssessmentDataSourceDocumentName
                        </td>
                        <td>
                            @task.Workspace
                        </td>
                        <td>
                            @task.TaskType
                        </td>
                        <td>
                            @task.TaskStage
                        </td>
                        <td></td>
                        <td></td>
                        <td>
                            @task.Team
                        </td>
                        <td>
                            <i class="fas fa-cog black"></i>
                        </td>
                        <td>
                            @task.TaskNote
                        </td>
                    </tr>
                }

            </tbody>
        </table>
    </div>
</div>

<br />

<div class="panel panel-default">
    <div class="panel-heading">
        <span>In Flight Tasks</span>
    </div>
    <div class="panel-body table-responsive">
        <table id="inFlightTasks" class="task-list table-striped" style="width: 100%">
            <thead>
                <tr>
                    <th>Process ID</th>
                    <th>
                        <div>Days to DM</div>
                        <div>End Date</div>
                    </th>
                    <th>DM End Date</th>
                    <th>Days On Hold</th>
                    <th>RSDRA No.</th>
                    <th>Source Name</th>
                    <th>Workspace</th>
                    <th>Task Type</th>
                    <th>Task Stage</th>
                    <th>Assessor</th>
                    <th>Verifier</th>
                    <th>Team</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var task in Model.Tasks.Where(t => !string.IsNullOrEmpty(t.DbAssessmentReviewDataAssessor) || !string.IsNullOrEmpty(t.DbAssessmentReviewDataVerifier)))
                {
                    string rowColour = "black";

                    if (task.DaysToDmEndDate >= 1 && task.DaysToDmEndDate <= 2)
                    {
                        rowColour = "amber";
                    }
                    else if (task.DaysToDmEndDate <= 0)
                    {
                        rowColour = "red";
                    }

                    <tr class="@rowColour">
                        <td>
                            <a asp-area="DbAssessment"
                               asp-page="Review"
                               asp-route-processid="@task.ProcessId">@task.ProcessId</a>
                        </td>
                        <td>
                            @task.DaysToDmEndDate
                        </td>
                        <td>
                            @task.DmEndDate.ToShortDateString()
                        </td>
                        <td>
                            @task.DaysOnHold
                            @{
                                if (task.DaysOnHold <= 5 && task.DaysOnHold >= 1)
                                {
                                    <i class="far fa-pause-circle black"></i>
                                }
                                else if (task.DaysOnHold >= 6)
                                {
                                    <i class="far fa-pause-circle red"></i>
                                }
                            }
                        </td>
                        <td>
                            @task.AssessmentDataRsdraNumber
                        </td>
                        <td>
                            @task.AssessmentDataSourceDocumentName
                        </td>
                        <td>
                            @task.Workspace
                        </td>
                        <td>
                            @task.TaskType
                        </td>
                        <td>
                            @task.TaskStage
                        </td>
                        <td>
                            @task.DbAssessmentReviewDataAssessor
                        </td>
                        <td>
                            @task.DbAssessmentReviewDataVerifier
                        </td>
                        <td>
                            @task.Team
                        </td>
                        <td>
                            <i class="fas fa-cog black"></i>
                        </td>
                        <td>
                            @task.TaskNote
                        </td>
                    </tr>
                }

            </tbody>
        </table>
    </div>
</div>

@section Scripts {

    <script>
        $(document).ready(function () {
            var unassignedTasksTable = $('#unassignedTasks').DataTable({
                "pageLength": 5,
                'sDom': 'ltipr',
                "lengthMenu": [5, 10, 25, 50],
                'columnDefs': [{
                    'targets': [12],
                    'orderable': false,
                    'searchable': false
                },
                {
                    'targets': [13],
                    'visible': false,
                    'searchable': false
                }]
            });
            var inFlightTasksTable = $('#inFlightTasks').DataTable({
                "lengthMenu": [10, 25, 50],
                'sDom': 'ltipr',
                'columnDefs': [{
                    'targets': [12],
                    'orderable': false,
                    'searchable': false
                },
                {
                    'targets': [13],
                    'visible': false,
                    'searchable': false
                }]
            });

            $('#inFlightTasks tbody tr').each(function (index, tr) {

                var row = inFlightTasksTable.row(tr);
                var taskNote = row.data()[13];

                if (taskNote.length > 0) {
                    row.child("<b>Note: </b>" + taskNote).show();
                    row.child().children("td").addClass("note-formatting");
                } else {
                    row.child("").show();
                }

                $(tr).addClass('shown');

                if ($(tr).hasClass('red')) {
                    row.child().addClass('red');
                } else if ($(tr).hasClass('amber')) {
                    row.child().addClass('amber');
                } else if ($(tr).hasClass('black')) {
                    row.child().addClass('black');
                }
            });

            $('#txtGlobalSearch').keyup(function () {
                unassignedTasksTable.search($(this).val()).draw();
                inFlightTasksTable.search($(this).val()).draw();
            });
        });
    </script>
}
